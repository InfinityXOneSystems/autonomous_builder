name: Infinity Prime Approver (SAFE only)

on:
  pull_request_target:
    types: [labeled, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write
  contents: read

jobs:
  approve:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    steps:
      - name: Wait for required checks (best-effort)
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner, repo = context.repo.repo;
            const sha = pr.head.sha;
            const sleep = ms => new Promise(r => setTimeout(r, ms));
            for (let i=0; i<30; i++) {
              const { data } = await github.rest.checks.listForRef({ owner, repo, ref: sha });
              const all = data.check_runs || [];
              const required = ["CI (checks)"];
              const ok = required.every(n => all.some(c => c.name === n && c.conclusion === "success"));
              if (ok) return;
              await sleep(20000);
            }
            core.setFailed("Required checks not green yet.");

      - name: Enable auto-merge when SAFE + automerge label present
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const labels = pr.labels.map(l => l.name);
            if (!labels.includes("automerge")) {
              core.info("No 'automerge' label; leaving as manual merge.");
              return;
            }
            // SAFE-only: requires risk gate report to be SAFE (produced by CI). Conservative default:
            // If tier-3/4 labels exist, do not auto-approve.
            if (labels.includes("tier-3") || labels.includes("tier-4") || labels.includes("blocked-approval-required")) {
              core.info("Blocked tier; not approving.");
              return;
            }
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event: "APPROVE",
              body: "âœ… Infinity Prime auto-approval (SAFE-only, gates green)."
            });
